<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="lib/bootstrap.min.css" rel="stylesheet">
  <link href="lib/bootstrap-icons.css" rel="stylesheet">
  <title>VVdeC Web Player - Vue3 SDK</title>
  <style>
    #canvas {
      background-image: url("img/VVC_vertical.png");
      background-repeat: no-repeat;
      background-position: center;
      background-size: 200px;
      background-color: white !important;
    }
    #canvas:fullscreen {
      background-color: black !important;
    }
    .player-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .control-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(0,0,0,0.8);
      border-radius: 0 0 8px 8px;
    }
    .url-input {
      flex: 1;
    }
  </style>
</head>
<body class="bg-dark">
  <div id="app">
    <div class="player-container">
      <h2 class="text-light text-center mb-4">
        <img src="img/Logo_FHG_cube_only.svg" style="height: 2rem;" class="me-2">
        VVC Web Player (Vue3 SDK)
      </h2>
      
      <!-- URL 输入 -->
      <div class="input-group mb-3">
        <input type="text" class="form-control" v-model="videoUrl" 
               @keydown.enter="playVideo" placeholder="输入视频 URL (.mp4, .266, .vvc, .mpd)">
        <button class="btn btn-primary" @click="playVideo" :disabled="!playerReady">
          <i class="bi bi-play-fill"></i> 播放
        </button>
      </div>
      
      <!-- 播放器 -->
      <div class="bg-black rounded overflow-hidden">
        <canvas ref="canvas" class="d-block mx-auto" style="width: 100%; max-width: 800px;"></canvas>
        
        <!-- 控制栏 -->
        <div class="control-bar">
          <button class="btn btn-sm" :class="isPlaying ? 'btn-warning' : 'btn-success'" 
                  @click="togglePlay" :disabled="!playerReady">
            <i :class="isPlaying ? 'bi-pause-fill' : 'bi-play-fill'"></i>
          </button>
          <button class="btn btn-sm btn-danger" @click="stopVideo" :disabled="!playerReady">
            <i class="bi-stop-fill"></i>
          </button>
          
          <!-- 音量 -->
          <div class="d-flex align-items-center gap-2" v-show="hasAudio">
            <button class="btn btn-sm btn-secondary" @click="toggleMute">
              <i :class="isMuted ? 'bi-volume-mute-fill' : 'bi-volume-up-fill'"></i>
            </button>
            <input type="range" class="form-range" style="width: 80px;" 
                   min="0" max="100" v-model="volume" @input="updateVolume">
          </div>
          
          <!-- 状态 -->
          <span class="text-light ms-auto">{{ statusText }}</span>
        </div>
      </div>
      
      <!-- 日志 -->
      <div class="mt-3">
        <button class="btn btn-sm btn-outline-secondary" @click="showLog = !showLog">
          {{ showLog ? '隐藏日志' : '显示日志' }}
        </button>
        <textarea v-show="showLog" class="form-control mt-2" rows="8" readonly 
                  :value="logText" style="font-family: monospace; font-size: 12px;"></textarea>
      </div>
      
      <!-- 错误提示 -->
      <div v-if="errorMsg" class="alert alert-danger mt-3" style="white-space: pre-line;">
        {{ errorMsg }}
      </div>
      
      <!-- 使用说明 -->
      <div class="card mt-3 bg-dark text-light border-secondary">
        <div class="card-body">
          <h6 class="card-title">使用说明</h6>
          <p class="small mb-2">方法一：使用 Python 服务器</p>
          <ol class="small mb-2">
            <li>运行: <code>python wasm_test-server.py</code></li>
            <li>访问: <code>http://127.0.0.1:8000/index1.html</code></li>
          </ol>
          <p class="small mb-2">方法二：Vue/Vite 项目</p>
          <ol class="small mb-0">
            <li>在 vite.config.js 中配置 CORS 头（参考项目中的 vite.config.js）</li>
            <li>将 sdk 目录复制到 Vue 项目的 public 目录</li>
            <li>在组件中导入: <code>import { createVVCPlayer } from '/sdk/VVCPlayerSDK.mjs'</code></li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <script src="lib/bootstrap.min.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  
  <!-- 注册 Service Worker 启用 SharedArrayBuffer -->
  <script>
    // 检查是否需要注册 Service Worker
    if (!window.crossOriginIsolated && 'serviceWorker' in navigator) {
      // 优先使用 SDK 目录的 Service Worker
      navigator.serviceWorker.register('./sdk/coi-serviceworker.js').then(() => {
        if (!window.crossOriginIsolated) {
          console.log('Service Worker registered, reloading page...');
          window.location.reload();
        }
      }).catch(err => {
        console.warn('Service Worker registration failed:', err);
      });
    }
  </script>
  
  <script type="module">
    import { createVVCPlayer, setSDKBasePath } from './sdk/VVCPlayerSDK.mjs';

    const { createApp, ref, onMounted, onUnmounted } = Vue;

    createApp({
      setup() {
        // 播放器实例
        let player = null;
        
        // Refs
        const canvas = ref(null);
        const videoUrl = ref('');
        const playerReady = ref(false);
        const isPlaying = ref(false);
        const hasAudio = ref(false);
        const volume = ref(100);
        const isMuted = ref(false);
        const statusText = ref('等待初始化...');
        const logText = ref('');
        const showLog = ref(false);
        const errorMsg = ref('');

        // 日志
        const log = (msg) => {
          logText.value += msg + '\n';
          console.log(msg);
        };

        // 初始化播放器
        const initPlayer = async () => {
          // 检查环境
          if (!window.SharedArrayBuffer) {
            errorMsg.value = 'SharedArrayBuffer 不可用！\n\n' +
              '请使用以下方法之一：\n' +
              '1. 运行 python wasm_test-server.py 启动服务器\n' +
              '2. 或在 vite.config.js 中配置 CORS 头（参考项目中的 vite.config.js）\n' +
              '\n使用 Chrome 或 Edge 浏览器';
            statusText.value = '初始化失败';
            log('错误: SharedArrayBuffer 不可用');
            return;
          }
          
          if (window.crossOriginIsolated === false) {
            log('警告: crossOriginIsolated = false，可能影响 WASM 多线程');
          }
          
          try {
            // 设置 SDK 路径
            setSDKBasePath('./sdk/');
            
            log('正在初始化播放器...');
            
            // 创建播放器
            player = await createVVCPlayer(canvas.value, {
              sdkPath: './sdk/',
              threads: 10,
              fixedSize: true
            });
            
            // 事件监听
            player.on('statusChange', (status) => {
              isPlaying.value = status === 'play';
              if (status === 'stop') statusText.value = '已停止';
            });
            
            player.on('frame', (frame) => {
              statusText.value = `${frame.width}x${frame.height}`;
            });
            
            player.on('metadata', (data) => {
              hasAudio.value = player.hasAudio;
              log(`元数据: ${JSON.stringify(data)}`);
            });
            
            player.on('log', log);
            
            player.on('error', (msg) => {
              log('错误: ' + msg);
              errorMsg.value = msg;
            });
            
            player.on('eof', () => {
              log('播放结束');
              statusText.value = '播放结束';
            });
            
            playerReady.value = true;
            statusText.value = '就绪 - 请输入视频 URL';
            log('播放器初始化成功');
            
          } catch (e) {
            errorMsg.value = '初始化失败: ' + e.message;
            statusText.value = '初始化失败';
            log('初始化失败: ' + e.message);
            console.error(e);
          }
        };

        // 播放视频
        const playVideo = () => {
          if (!player || !videoUrl.value.trim()) return;
          errorMsg.value = '';
          logText.value = '';
          log('开始播放: ' + videoUrl.value);
          player.play(videoUrl.value.trim());
          statusText.value = '加载中...';
        };

        // 切换播放/暂停
        const togglePlay = () => {
          if (!player) return;
          if (!player.togglePlay()) {
            // 需要先 play(url)
            if (videoUrl.value) playVideo();
          }
        };

        // 停止
        const stopVideo = () => {
          if (player) {
            player.stop();
            statusText.value = '已停止';
          }
        };

        // 音量控制
        const updateVolume = () => {
          if (player) {
            player.setVolume(volume.value / 100);
            isMuted.value = volume.value === 0;
          }
        };

        const toggleMute = () => {
          isMuted.value = !isMuted.value;
          if (player) player.setMuted(isMuted.value);
        };

        // 生命周期
        onMounted(() => {
          initPlayer();
        });

        onUnmounted(() => {
          if (player) player.destroy();
        });

        return {
          canvas,
          videoUrl,
          playerReady,
          isPlaying,
          hasAudio,
          volume,
          isMuted,
          statusText,
          logText,
          showLog,
          errorMsg,
          playVideo,
          togglePlay,
          stopVideo,
          updateVolume,
          toggleMute,
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
